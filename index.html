<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>THE GREAT INDIA SHOWCASE 2026 ‚Äî LUCKY DRAW</title>

<!-- Confetti & Papa Parse (CDN) -->
<script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>

<style>
  :root{
    --bg:#002f61; --text:#fff; --shadow:rgba(0,0,0,.35);

    /* Golden theme */
    --gift-base:#f8dc8a; --gift-shade:#e8c759;
    --lid-base:#f8dc8a;  --lid-shade:#e6c45a;

    /* Buttons */
    --btn-bg:#f8dc8a; --btn-text:#000;

    /* Logos */
    --logo-top-width:160px;
    --logo-end-width:240px;

    /* Bow (PNG) ‚Äî as requested */
    --bow-width: 360px;
  }

  *{box-sizing:border-box}
  body{
    margin:0; background:var(--bg); color:var(--text);
    font:16px/1.4 system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
    min-height:100vh; display:flex; flex-direction:column; align-items:center; gap:14px;
  }

  .container{width:min(92vw,900px); margin:0 auto; position:relative}
  header.container{text-align:center; margin-top:14px}
  h1{margin:0 0 4px; letter-spacing:.6px; font-weight:800}
  .sub{opacity:.95; font-size:1rem; font-weight:700; letter-spacing:.25px}

  .topbar.container{display:grid; grid-template-columns:1fr auto auto; align-items:center; gap:12px}
  #controls{display:flex; flex-wrap:wrap; gap:10px; justify-content:flex-start}

  .menu-btn,.fs-btn{
    justify-self:end; appearance:none; border:none; background:rgba(255,255,255,.16); color:#fff;
    width:44px; height:44px; border-radius:10px; display:grid; place-items:center; box-shadow:0 4px 14px rgba(0,0,0,.25); cursor:pointer;
  }
  .menu-btn:hover,.fs-btn:hover{ filter:brightness(1.08) }

  .btn{
    appearance:none; border:2px solid rgba(0,0,0,.15); border-radius:12px; padding:12px 16px; font-weight:800; letter-spacing:.2px;
    background:var(--btn-bg); color:var(--btn-text);
    box-shadow:0 6px 0 rgba(0,0,0,.18), 0 12px 24px rgba(0,0,0,.15);
    transform:translateY(0); transition: transform .06s ease, box-shadow .2s ease, filter .2s ease;
  }
  .btn:hover{ filter:brightness(1.03) }
  .btn:active{ transform:translateY(2px); box-shadow:0 4px 0 rgba(0,0,0,.18), 0 10px 20px rgba(0,0,0,.15) }
  .btn:disabled{ opacity:.6; cursor:not-allowed }
  .btn.ghost{ background:transparent; color:#fff; border:2px solid rgba(255,255,255,.5); box-shadow:none }

  .stage.container{display:grid; place-items:center; position:relative}
  .gift{
    width:100%; height:min(70vh,520px); position:relative; display:grid; place-items:center; perspective:900px; margin-top:4px;
  }

  .box-base{
    position:absolute; inset:140px 0 0 0; margin:auto; width:100%; height:calc(100% - 140px);
    background:linear-gradient(145deg, var(--gift-base), var(--gift-shade));
    border-radius:14px; border:4px solid #fff; overflow:hidden;
    box-shadow:0 16px 40px var(--shadow), inset 0 0 0 2px rgba(255,255,255,.2);
    z-index:1;
  }

  .lid-wrap{ position:absolute; width:100%; left:0; right:0; top:0; height:150px; pointer-events:none; z-index:5; }
  .lid{
    position:absolute; width:calc(100% + 16px); height:120px; left:50%; transform:translateX(-50%);
    top:20px; border-radius:12px; border:4px solid #fff; background:linear-gradient(145deg, var(--lid-base), var(--lid-shade));
    box-shadow:0 10px 20px var(--shadow); transform-origin:center bottom;
  }

  /* Bow PNG only ‚Äî centered on lid; size via --bow-width */
  #bowImg{ position:absolute; left:50%; transform:translateX(-50%); top:-6px; width:var(--bow-width); height:auto; pointer-events:none }

  /* Entries grid inside box */
  .box-content{
    position:absolute; inset:160px 16px 16px 16px; display:grid; grid-template-columns:repeat(auto-fill, minmax(190px,1fr));
    gap:10px; align-content:start; overflow:hidden; scrollbar-width:thin; z-index:2;
  }
  .entry{
    background:linear-gradient(145deg, rgba(255,255,255,.98), rgba(246,246,246,.98));
    border:1px solid rgba(0,0,0,.06);
    padding:10px; border-radius:10px; text-align:center; font-size:.98rem; animation:blink 1.2s infinite;
    transition: transform .12s ease, left .35s ease, top .35s ease; color:#111; font-weight:600;
    box-shadow:inset 0 1px 0 rgba(255,255,255,.85), inset 0 -1px 0 rgba(0,0,0,.06);
  }
  .entry .name{ font-weight:800; display:block; color:#000 }
  .entry .company{ font-size:.85rem; opacity:.85; color:#222 }
  @keyframes blink{ 0%,100%{opacity:1} 50%{opacity:.45} }
  .free .entry{ position:absolute; width:190px; }

  /* Overlays & modals */
  .overlay{ position:fixed; inset:0; display:none; place-items:center; background:rgba(0,0,0,.35); z-index:500; backdrop-filter:blur(1px); }
  .modal{ background:#fff; color:#111; width:min(92vw, 720px); border-radius:14px; box-shadow:0 24px 60px rgba(0,0,0,.45); position:relative; }
  .modal .head{ padding:14px 18px; border-bottom:1px solid #eee; font-weight:800; display:flex; align-items:center; justify-content:space-between; }
  .modal .body{ padding:16px 18px; max-height:70vh; overflow:auto; }
  .modal .close{ appearance:none; background:transparent; border:none; font-size:20px; cursor:pointer; }

  #countOverlay .count{ font-size:clamp(64px, 12vw, 140px); font-weight:900; text-shadow:0 6px 0 rgba(0,0,0,.3); color:#fff; }
  #countOverlay .label{ margin-top:6px; font-size:1.1rem; opacity:.95; color:#fff; text-align:center; }
  #winnerName{ font-size:clamp(28px, 5vw, 60px); font-weight:900; line-height:1.2; text-align:center; }
  #winnerModal .body{ display:grid; gap:12px; place-items:center; }

  /* Drawer */
  .drawer-overlay{ position:fixed; inset:0; display:none; background:rgba(0,0,0,0.25); z-index:200; }
  .drawer{
    position:fixed; right:0; top:0; width:min(90vw, 340px); height:100vh; transform:translateX(100%);
    background:rgba(255,255,255,0.7); color:#000; backdrop-filter:blur(10px);
    box-shadow:-14px 0 40px rgba(0,0,0,.35); z-index:210; transition:transform .25s ease; display:flex; flex-direction:column;
  }
  .drawer.open{ transform:translateX(0) }
  .drawer .hd{ display:flex; align-items:center; justify-content:space-between; padding:14px 16px; font-weight:800; border-bottom:1px solid rgba(0,0,0,.1) }
  .drawer .cnt{ padding:12px 16px; display:grid; gap:12px; }
  .drawer .row{ display:flex; align-items:center; justify-content:space-between; }
  .drawer label{ font-weight:700; }

  /* Lucky Ones modal */
  #luckyOverlay .modal{ width:min(96vw, 820px) }
  .searchbar{ display:flex; gap:8px; margin-bottom:10px; }
  .searchbar input{ flex:1; padding:10px 12px; border:1px solid #ccc; border-radius:10px; font-size:14px; }
  .lucky-grid{ display:grid; grid-template-columns:repeat(auto-fill, minmax(240px,1fr)); gap:10px; max-height:52vh; overflow:auto; }
  .cand{ border:1px solid #ddd; border-radius:10px; padding:10px; display:flex; align-items:center; justify-content:space-between; background:#fff; }
  .cand .meta{ display:grid; }
  .cand .name{ font-weight:800; }
  .cand .company{ font-size:.9rem; opacity:.85 }
  .pick-btn{ padding:8px 10px; border-radius:10px; border:none; cursor:pointer; font-weight:800; }
  .pick-btn.sel{ background:#0b7dda; color:#fff }
  .pick-btn.n{ background:#f1f1f1 }
  .lucky-selected{ margin:8px 0 12px; padding:10px; border-radius:10px; background:#fff; border:1px solid #eee; }
  .lucky-selected strong{ margin-right:8px; display:inline-block; }

  /* Logos */
  #logoTopAbs{ position:absolute; left:22px; width:var(--logo-top-width); height:auto; z-index:300; }

  /* End logo (absolute to PAGE). JS writes the exact document 'top'. */
  #logoEndWrap{
    position: absolute;
    left: 50%;
    transform: translateX(-50%);
    top: 0;                   /* JS sets this */
    z-index: 150;
    pointer-events: none;
  }
  #logoEnd{ width:var(--logo-end-width); height:auto; pointer-events:auto; }
</style>
</head>
<body>
  <!-- Top-left logo aligned to H1 top via JS -->
  <img id="logoTopAbs" src="assets/logo-top.png" alt="Company Logo" />

  <header class="container" id="pageHeader">
    <h1>THE GREAT INDIA SHOWCASE 2026</h1>
    <div class="sub">LUCKY DRAW</div>
  </header>

  <div class="topbar container">
    <div id="controls">
      <button id="btnStart" class="btn">üé¨ Start Draw</button>
      <button id="btnRefresh" class="btn">üîÑ Refresh Participants</button>
    </div>
    <button id="btnFullscreen" class="fs-btn" title="Fullscreen">‚õ∂</button>
    <button id="btnMenu" class="menu-btn" title="Menu">‚ò∞</button>
  </div>

  <div class="stage container">
    <div class="gift" aria-label="Gift Box">
      <div class="lid-wrap">
        <div class="lid" id="lid">
          <!-- Bow: PNG only, centered; size via --bow-width -->
          <img id="bowImg" src="assets/bow.png" alt="Bow" />
        </div>
      </div>
      <div class="box-base" aria-hidden="true"></div>
      <div id="entries" class="box-content">Loading participants‚Ä¶</div>
    </div>
  </div>

  <!-- End logo wrapper; JS ensures it's under <body> and 5px below box, centered on PAGE -->
  <div id="logoEndWrap"><img id="logoEnd" src="assets/logo-end.png" alt="End Logo" /></div>

  <!-- Overlays -->
  <div id="countOverlay" class="overlay">
    <div style="text-align:center;">
      <div class="count" id="countText"></div>
      <div class="label" id="phaseLabel"></div>
    </div>
  </div>

  <div id="winnerOverlay" class="overlay">
    <div id="winnerModal" class="modal">
      <div class="head">Winner <button class="close" id="closeWinner" type="button">‚úï</button></div>
      <div class="body">
        <div id="winnerName">Winner Name</div>
        <div id="winnerCompany" style="font-size:1.1rem; opacity:.85"></div>
      </div>
    </div>
  </div>

  <div id="winnersOverlay" class="overlay">
    <div id="winnersModal" class="modal">
      <div class="head">Past Winners <button class="close" id="closeWinners" type="button">‚úï</button></div>
      <div class="body">
        <ol id="winnersList"></ol>
        <div style="display:flex; gap:10px; justify-content:center; margin-top:8px">
          <button id="btnReset" class="btn">‚ôªÔ∏è Reset Draw</button>
          <button id="btnExportWinners" class="btn ghost">‚¨áÔ∏è Download Winners CSV</button>
        </div>
      </div>
    </div>
  </div>

  <div id="luckyOverlay" class="overlay">
    <div id="luckyModal" class="modal">
      <div class="head">Lucky Ones (Pick next up to 3 winners) <button class="close" id="closeLucky" type="button">‚úï</button></div>
      <div class="body">
        <div class="lucky-selected"><strong>Selected order:</strong> <span id="luckySelected"></span>
          <button id="btnClearRig" class="btn" style="margin-left:10px;">Make Random Again</button>
        </div>
        <div class="searchbar">
          <input id="luckySearch" placeholder="Search name or company..." />
          <button id="luckyRefresh" class="btn ghost">Refresh List</button>
        </div>
        <div id="luckyGrid" class="lucky-grid"></div>
      </div>
    </div>
  </div>

  <!-- Drawer -->
  <div id="drawerMask" class="drawer-overlay"></div>
  <aside id="drawer" class="drawer" aria-label="Menu">
    <div class="hd">Menu
      <button id="closeDrawer" class="menu-btn" style="background:transparent;color:#000;width:auto;height:auto;padding:6px 10px;" type="button">‚úï</button>
    </div>
    <div class="cnt">
      <div class="row"><label for="autoRefresh">Auto-Refresh (10s)</label><input type="checkbox" id="autoRefresh"></div>
      <button id="btnSound" class="btn" title="Use your own MP3s (assets/drum.mp3 & assets/pop.mp3 & assets/clap.mp3)">üîä Enable Sound</button>
      <button id="btnWinners" class="btn ghost">üèÜ Past Winners</button>
      <button id="btnLucky" class="btn ghost">üçÄ Lucky Ones</button>
    </div>
  </aside>

  <!-- Audio (local; user-provided) -->
  <audio id="drum" preload="auto" src="assets/drum.mp3"></audio>
  <audio id="pop"  preload="auto" src="assets/pop.mp3"></audio>
  <audio id="clap" preload="auto" src="assets/clap.mp3"></audio>

<script>
(function(){
  /* ---------- Config ---------- */
  const DEFAULT_SHEET_CSV = "https://docs.google.com/spreadsheets/d/e/2PACX-1vR9EzQVA4kCkKxyzpQ2S61wrHce8ohaH7v_QvgPzfLqNMkghG3O-_JGYQBVcUmE0-Y-vsKio3pnTeh5/pub?output=csv";
  const DRAW_COUNTDOWN_SEC=3, DRAW_PHASE_MS=5000, AUTO_REFRESH_MS=10000, BLINK_MS=1200;

  /* ---------- State ---------- */
  let participants=[], activePool=[], winners=[], luckyQueue=[];
  let autoTimer=null, drawing=false, moveTimer=null, idleShuffleTimer=null;

  /* ---------- Elements ---------- */
  const entriesEl=document.getElementById('entries'), lidEl=document.getElementById('lid');
  const countOverlay=document.getElementById('countOverlay'), countText=document.getElementById('countText'), phaseLabel=document.getElementById('phaseLabel');
  const btnRefresh=document.getElementById('btnRefresh'), btnStart=document.getElementById('btnStart'), btnReset=document.getElementById('btnReset');
  const chkAuto=document.getElementById('autoRefresh'), btnSound=document.getElementById('btnSound'), btnWinners=document.getElementById('btnWinners'), btnLucky=document.getElementById('btnLucky');
  const btnMenu=document.getElementById('btnMenu'), drawer=document.getElementById('drawer'), drawerMask=document.getElementById('drawerMask'), closeDrawer=document.getElementById('closeDrawer');
  const drum=document.getElementById('drum'), pop=document.getElementById('pop'), clap=document.getElementById('clap');
  if(drum){ drum.volume=.9; } if(pop){ pop.volume=.7; } if(clap){ clap.volume=.7; }

  const winnerOverlay=document.getElementById('winnerOverlay'), closeWinner=document.getElementById('closeWinner'), winnerNameEl=document.getElementById('winnerName'), winnerCompanyEl=document.getElementById('winnerCompany');
  const winnersOverlay=document.getElementById('winnersOverlay'), closeWinners=document.getElementById('closeWinners'), winnersListEl=document.getElementById('winnersList');
  const luckyOverlay=document.getElementById('luckyOverlay'), luckyGrid=document.getElementById('luckyGrid'), luckySelected=document.getElementById('luckySelected'), luckySearch=document.getElementById('luckySearch'), luckyRefresh=document.getElementById('luckyRefresh'), btnClearRig=document.getElementById('btnClearRig');

  /* ---------- Small utilities ---------- */
  function getCsvUrl(){
    const urlParam=new URLSearchParams(location.search).get('csv');
    let url=urlParam?decodeURIComponent(urlParam):DEFAULT_SHEET_CSV;
    const marker='output=csv'; const idx=url.indexOf(marker);
    if(idx!==-1) url=url.slice(0,idx+marker.length); // keep exactly ...output=csv
    return url;
  }
  function disableControls(d){ [btnStart,btnRefresh,btnReset,chkAuto,btnSound,btnWinners,btnLucky].forEach(el=>{ if(el) el.disabled=d; }); }
  function escapeHtml(s){ return String(s).replace(/[&<>"]/g, c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[c])); }

  /* ---------- Rendering ---------- */
  function renderEntries(){
    if(!entriesEl) return;
    if(!activePool.length){ entriesEl.textContent='No participants available.'; return; }
    entriesEl.innerHTML=activePool.map(p=>{
      const m=p.match(/^(.*) \((.*)\)$/);
      const name=m?m[1]:p; const company=m?m[2]:'';
      return `<div class="entry"><span class="name">${escapeHtml(name)}</span><span class="company">${escapeHtml(company)}</span></div>`;
    }).join('');
  }
  function renderWinners(){ if(winnersListEl) winnersListEl.innerHTML=winners.map(w=>`<li>${escapeHtml(w)}</li>`).join(''); }

  /* ---------- Data ---------- */
  async function refreshParticipants(){
    try{
      const res=await fetch(getCsvUrl(),{cache:'no-store'});
      if(!res.ok) throw new Error('Network error');
      const csv=await res.text();
      const parsed=Papa.parse(csv,{header:true,skipEmptyLines:true});
      const rows=parsed.data;

      const toKey=s=>String(s||'').trim().toLowerCase();
      const mapped=rows.map(r=>{
        const o={}; Object.keys(r).forEach(k=>o[toKey(k)]=r[k]);
        const full=(o['full name']||o['fullname']||o['name']||'').toString().trim();
        const comp=(o['name of company']||o['company']||'').toString().trim();
        return {full,comp};
      }).filter(x=>x.full&&x.comp);

      participants = mapped.map(x=>`${x.full} (${x.comp})`);
      const seen=new Set(); participants=participants.filter(p=>seen.has(p)?false:(seen.add(p),true));
      activePool = participants.filter(p=>!winners.includes(p));
      luckyQueue = luckyQueue.filter(p=>activePool.includes(p)).slice(0,3);

      renderEntries(); startIdleShuffle();
    }catch(e){
      console.error(e); if(entriesEl) entriesEl.textContent='Unable to load participants.';
    }
  }

  /* ---------- Idle shuffle & free-move ---------- */
  function startIdleShuffle(){
    stopIdleShuffle();
    idleShuffleTimer=setInterval(()=>{
      if(drawing || activePool.length<2) return;
      for(let i=activePool.length-1;i>0;i--){
        if(Math.random()<0.25){
          const j=Math.floor(Math.random()*(i+1));
          [activePool[i],activePool[j]]=[activePool[j],activePool[i]];
        }
      }
      renderEntries();
    }, BLINK_MS);
  }
  function stopIdleShuffle(){ if(idleShuffleTimer){ clearInterval(idleShuffleTimer); idleShuffleTimer=null; } }

  function startFreeMove(){
    stopIdleShuffle();
    if(!entriesEl) return;
    entriesEl.classList.add('free');
    const items=[...entriesEl.children];
    randomizePositions(items);
    moveTimer=setInterval(()=>randomizePositions(items),380);
  }
  function randomizePositions(items){
    if(!entriesEl) return;
    const b=entriesEl.getBoundingClientRect();
    items.forEach(el=>{
      const r=el.getBoundingClientRect(); const w=r.width||190, h=r.height||68;
      const pad=6; const maxX=Math.max(0,b.width-w-pad); const maxY=Math.max(0,b.height-h-pad);
      const x=Math.floor(Math.random()*maxX)+pad/2; const y=Math.floor(Math.random()*maxY)+pad/2;
      const rot=(Math.random()*10-5); const scale=1+(Math.random()*0.08);
      el.style.left=x+'px'; el.style.top=y+'px'; el.style.transform=`rotate(${rot}deg) scale(${scale})`;
    });
  }
  function stopFreeMove(){
    clearInterval(moveTimer); moveTimer=null;
    if(!entriesEl) return;
    entriesEl.classList.remove('free');
    [...entriesEl.children].forEach(el=>{ el.style.left=''; el.style.top=''; el.style.transform='none'; });
    startIdleShuffle();
  }

  /* ---------- Draw flow ---------- */
  function countdown(sec){
    if(!countOverlay) return Promise.resolve();
    countOverlay.style.display='grid'; phaseLabel.textContent='Get Ready‚Ä¶';
    return new Promise(resolve=>{
      let cur=sec; countText.textContent=cur;
      const t=setInterval(()=>{
        cur-=1; countText.textContent=cur>0?cur:'Go!';
        if(cur<=0){ clearInterval(t); setTimeout(resolve,600); }
      },1000);
    });
  }
  async function startDraw(){
    if(drawing) return; if(!activePool.length){ alert('No participants left!'); return; }
    drawing=true; disableControls(true);
    await countdown(DRAW_COUNTDOWN_SEC);

    if(lidEl){ lidEl.classList.remove('lid-fly','lid-return'); void lidEl.offsetWidth; lidEl.classList.add('lid-fly'); }
    try{ drum.currentTime=0; await drum.play(); }catch(e){}

    phaseLabel.textContent='Drawing‚Ä¶'; if(countText) countText.textContent='';
    startFreeMove(); await new Promise(r=>setTimeout(r,DRAW_PHASE_MS)); stopFreeMove();

    let winner=null;
    if(luckyQueue.length){
      const idx=luckyQueue.findIndex(p=>activePool.includes(p));
      if(idx!==-1){ winner=luckyQueue[idx]; luckyQueue.splice(idx,1); }
    }
    if(!winner){ winner=activePool[Math.floor(Math.random()*activePool.length)]; }

    winners.push(winner); activePool=activePool.filter(p=>p!==winner);

    burstConfetti();
    try{ pop.currentTime=0; await pop.play(); }catch(e){}

    const m=winner.match(/^(.*) \((.*)\)$/);
    if(winnerNameEl) winnerNameEl.textContent=m?m[1]:winner;
    if(winnerCompanyEl) winnerCompanyEl.textContent=m?m[2]:'';

    if(winnerOverlay) winnerOverlay.style.display='grid';
    if(countOverlay) countOverlay.style.display='none';

    try{ clap.currentTime=0; clap.play(); }catch(e){}

    renderEntries(); renderWinners(); updateLuckySelected(); disableControls(false); drawing=false;
  }

  function burstConfetti(){
    const end=Date.now()+600;
    (function frame(){ confetti({particleCount:110, spread:75, startVelocity:58, origin:{y:0.7}}); if(Date.now()<end) requestAnimationFrame(frame); })();
    confetti({particleCount:200, angle:60, spread:60, origin:{x:0}, zIndex:200});
    confetti({particleCount:200, angle:120, spread:60, origin:{x:1}, zIndex:200});
  }

  function resetDraw(){
    winners=[]; activePool=participants.slice(); renderWinners(); renderEntries();
    if(lidEl){ lidEl.classList.remove('lid-fly','lid-return'); }
    luckyQueue=[]; updateLuckySelected();
  }

  function downloadWinnersCSV(){
    if(!winners.length){ alert('No winners yet.'); return; }
    const rows=[["Full Name","Name of Company"]].concat(
      winners.map(w=>{ const m=w.match(/^(.*) \((.*)\)$/); return [m?m[1]:w, m?m[2]:'' ]; })
    );
    const csv=rows.map(r=>r.map(v=>'"'+String(v).replace(/"/g,'""')+'"').join(',')).join('\n');
    const blob=new Blob([csv],{type:'text/csv;charset=utf-8;'}); const url=URL.createObjectURL(blob);
    const a=document.createElement('a'); a.href=url; a.download='past-winners.csv'; a.click(); URL.revokeObjectURL(url);
  }

  /* ---------- Drawer & Lucky Ones ---------- */
  function openDrawer(){ if(drawerMask) drawerMask.style.display='block'; if(drawer) drawer.classList.add('open'); }
  function closeDrawerFn(){ if(drawerMask) drawerMask.style.display='none'; if(drawer) drawer.classList.remove('open'); }

  function renderLuckyList(){
    if(!luckyGrid) return;
    const q=(luckySearch?.value||'').toLowerCase();
    const items=activePool.filter(p=>p.toLowerCase().includes(q));
    luckyGrid.innerHTML=items.map(p=>{
      const m=p.match(/^(.*) \((.*)\)$/); const name=m?m[1]:p; const comp=m?m[2]:'';
      const selected=luckyQueue.includes(p);
      return `<div class="cand"><div class="meta"><div class="name">${escapeHtml(name)}</div><div class="company">${escapeHtml(comp)}</div></div>
        <button class="pick-btn ${selected?'sel':'n'}" data-id="${escapeHtml(p)}">${selected?'Selected':'Pick'}</button></div>`;
    }).join('');
    luckyGrid.querySelectorAll('.pick-btn').forEach(btn=>{
      btn.addEventListener('click',()=>{
        const id=btn.getAttribute('data-id');
        if(luckyQueue.includes(id)){ luckyQueue=luckyQueue.filter(x=>x!==id); }
        else{
          if(luckyQueue.length>=3){ alert('You can only queue up to 3 Lucky Ones.'); return; }
          luckyQueue.push(id);
        }
        updateLuckySelected(); renderLuckyList();
      });
    });
  }
  function updateLuckySelected(){ if(luckySelected) luckySelected.textContent=luckyQueue.length?luckyQueue.map(x=>x.replace(/ \(.+$/,'')).join(' ‚Üí '):'None'; }
  function clearRig(){ luckyQueue=[]; updateLuckySelected(); renderLuckyList(); }

  /* ---------- Logo placement helpers ---------- */
  function ensureEndLogoAtBody(){
    const wrap=document.getElementById('logoEndWrap');
    if(wrap && wrap.parentElement!==document.body){
      document.body.appendChild(wrap);
    }
  }

  function placeLogoTop(){
    const header=document.getElementById('pageHeader');
    const logo=document.getElementById('logoTopAbs');
    if(!header||!logo) return;
    const top=header.getBoundingClientRect().top + window.scrollY;
    logo.style.top=top+'px';
    logo.style.left='22px';
  }

  // End logo: page-centered (absolute to body); exactly 5px below gift box
  function placeLogoEnd(){
    const gift=document.querySelector('.gift');
    const wrap=document.getElementById('logoEndWrap');
    if(!gift||!wrap) return;

    ensureEndLogoAtBody();

    const r=gift.getBoundingClientRect();
    wrap.style.top = (r.bottom + window.scrollY + 5) + 'px';
  }

  function placeAll(){ placeLogoTop(); placeLogoEnd(); }

  /* ---------- Modal close wiring (hardened) ---------- */
  function wireModalCloseButtons(){
    const lidEl          = document.getElementById('lid');
    const winnerOverlay  = document.getElementById('winnerOverlay');
    const closeWinner    = document.getElementById('closeWinner');
    const winnersOverlay = document.getElementById('winnersOverlay');
    const closeWinners   = document.getElementById('closeWinners');
    const luckyOverlay   = document.getElementById('luckyOverlay');
    const closeLucky     = document.getElementById('closeLucky');
    const clap           = document.getElementById('clap');

    if (closeWinner && winnerOverlay) {
      closeWinner.onclick = () => {
        winnerOverlay.style.display = 'none';
        try { clap.pause(); clap.currentTime = 0; } catch(e) {}
        if (lidEl) {
          lidEl.classList.remove('lid-fly','lid-return');
          void lidEl.offsetWidth;
          lidEl.classList.add('lid-return');
        }
      };
    }
    if (closeWinners && winnersOverlay) {
      closeWinners.onclick = () => { winnersOverlay.style.display = 'none'; };
    }
    if (closeLucky && luckyOverlay) {
      closeLucky.onclick = () => { luckyOverlay.style.display = 'none'; };
    }

    // Click outside modal to close
    if (winnerOverlay) {
      winnerOverlay.addEventListener('click', (e) => {
        if (e.target === winnerOverlay) {
          winnerOverlay.style.display = 'none';
          try { clap.pause(); clap.currentTime = 0; } catch(e) {}
          if (lidEl) {
            lidEl.classList.remove('lid-fly','lid-return');
            void lidEl.offsetWidth;
            lidEl.classList.add('lid-return');
          }
        }
      });
    }
    if (winnersOverlay) {
      winnersOverlay.addEventListener('click', (e) => {
        if (e.target === winnersOverlay) winnersOverlay.style.display = 'none';
      });
    }
    if (luckyOverlay) {
      luckyOverlay.addEventListener('click', (e) => {
        if (e.target === luckyOverlay) luckyOverlay.style.display = 'none';
      });
    }
  }

  /* ---------- Events ---------- */
  btnRefresh.addEventListener('click', refreshParticipants);
  btnStart  .addEventListener('click', startDraw);
  if(btnReset) btnReset.addEventListener('click', ()=>{ resetDraw(); renderWinners(); });

  if(chkAuto) chkAuto.addEventListener('change', ()=>{
    if(chkAuto.checked){ autoTimer=setInterval(refreshParticipants,AUTO_REFRESH_MS); }
    else { clearInterval(autoTimer); autoTimer=null; }
  });

  if(btnSound) btnSound.addEventListener('click', async ()=>{
    try{
      drum.volume=0; await drum.play(); drum.pause(); drum.currentTime=0; drum.volume=.9;
      pop .volume=0; await pop .play();  pop .pause();  pop .currentTime=0;  pop .volume=.7;
      clap.volume=0; await clap.play(); clap.pause(); clap.currentTime=0; clap.volume=.7;
      alert('Sound primed. Ensure assets/drum.mp3, assets/pop.mp3 & assets/clap.mp3 exist.');
    }catch(e){
      alert('Autoplay blocked OR MP3s missing. Sounds will play after interactions when available.');
    }
  });

  if(btnWinners) btnWinners.addEventListener('click', ()=>{ if(winnersOverlay) winnersOverlay.style.display='grid'; closeDrawerFn(); });
  if(btnMenu)    btnMenu   .addEventListener('click', openDrawer);
  if(closeDrawer) closeDrawer.addEventListener('click', closeDrawerFn);
  if(drawerMask)  drawerMask .addEventListener('click', closeDrawerFn);

  if(document.readyState === 'loading'){
    document.addEventListener('DOMContentLoaded', wireModalCloseButtons);
  }else{
    wireModalCloseButtons();
  }

  // Fullscreen toggle (hide button while in fullscreen)
  const btnFS=document.getElementById('btnFullscreen');
  function isFS(){ return !!(document.fullscreenElement || document.webkitFullscreenElement); }
  function enterFS(){ const el=document.documentElement; if(el.requestFullscreen) el.requestFullscreen(); else if(el.webkitRequestFullscreen) el.webkitRequestFullscreen(); }
  if(btnFS){
    btnFS.addEventListener('click', ()=>{ if(!isFS()) enterFS(); });
    document.addEventListener('fullscreenchange', ()=>{ if(btnFS) btnFS.style.display=isFS()?'none':'grid'; placeAll(); });
    document.addEventListener('webkitfullscreenchange', ()=>{ if(btnFS) btnFS.style.display=isFS()?'none':'grid'; placeAll(); });
  }

  // Keep placement aligned
  window.addEventListener('load', placeAll);
  window.addEventListener('resize', placeAll);
  window.addEventListener('scroll', placeAll, {passive:true});
  ['click','transitionend','animationend'].forEach(evt=>{
    document.addEventListener(evt, ()=>{ requestAnimationFrame(()=>requestAnimationFrame(placeAll)); });
  });

  // Re-place once end logo is loaded (height known)
  const endLogoImg=document.getElementById('logoEnd');
  if(endLogoImg){ endLogoImg.addEventListener('load', ()=>{ requestAnimationFrame(placeAll); }); }

  // Initial load
  refreshParticipants();
})();
</script>
</body>
</html>